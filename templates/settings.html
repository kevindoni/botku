<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - YouTube Streaming Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fab fa-youtube text-danger"></i>
                YouTube Streaming Bot
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a class="nav-link active" href="/settings">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="fas fa-cog"></i> Settings</h2>
                
                <!-- Alert Messages -->
                <div id="alertContainer"></div>

                <!-- Navigation Pills -->
                <ul class="nav nav-pills mb-3" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="streaming-tab" data-bs-toggle="pill" data-bs-target="#streaming" type="button">
                            <i class="fas fa-video"></i> Streaming
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bots-tab" data-bs-toggle="pill" data-bs-target="#bots" type="button">
                            <i class="fas fa-robot"></i> Bots
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="youtube-tab" data-bs-toggle="pill" data-bs-target="#youtube" type="button">
                            <i class="fab fa-youtube"></i> YouTube API
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="security-tab" data-bs-toggle="pill" data-bs-target="#security" type="button">
                            <i class="fas fa-shield-alt"></i> Security
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="settingsTabContent">
                    <!-- Streaming Settings -->
                    <div class="tab-pane fade show active" id="streaming" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-video"></i> Streaming Configuration</h5>
                            </div>
                            <div class="card-body">
                                <form id="streamingForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="streamKey" class="form-label">Stream Key</label>
                                                <div class="input-group">
                                                    <input type="password" class="form-control" id="streamKey" name="stream_key" required>
                                                    <button class="btn btn-outline-secondary" type="button" id="toggleStreamKey">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                                <div class="form-text">Your YouTube Live Stream Key</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="rtmpServer" class="form-label">RTMP Server</label>
                                                <input type="text" class="form-control" id="rtmpServer" name="rtmp_server" 
                                                       value="rtmp://a.rtmp.youtube.com/live2" required>
                                                <div class="form-text">YouTube RTMP Server URL</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="videoInput" class="form-label">Video Input</label>
                                                <select class="form-select" id="videoInput" name="video_input">
                                                    <option value="testsrc">Test Pattern</option>
                                                    <option value="webcam">Webcam</option>
                                                    <option value="screen">Screen Capture</option>
                                                    <option value="file">Video File</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="videoFile" class="form-label">Video File Path</label>
                                                <input type="text" class="form-control" id="videoFile" name="video_file" 
                                                       placeholder="/path/to/video.mp4">
                                                <div class="form-text">Required only for file input</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="resolution" class="form-label">Resolution</label>
                                                <select class="form-select" id="resolution" name="resolution">
                                                    <option value="1920x1080">1080p (1920x1080)</option>
                                                    <option value="1280x720">720p (1280x720)</option>
                                                    <option value="854x480">480p (854x480)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="bitrate" class="form-label">Bitrate (kbps)</label>
                                                <input type="number" class="form-control" id="bitrate" name="bitrate" 
                                                       value="2500" min="500" max="8000">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="framerate" class="form-label">Frame Rate</label>
                                                <select class="form-select" id="framerate" name="framerate">
                                                    <option value="30">30 FPS</option>
                                                    <option value="60">60 FPS</option>
                                                    <option value="25">25 FPS</option>
                                                    <option value="24">24 FPS</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="autoRestart" name="auto_restart">
                                                <label class="form-check-label" for="autoRestart">
                                                    Auto-restart on failure
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="recordLocal" name="record_local">
                                                <label class="form-check-label" for="recordLocal">
                                                    Record locally
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Streaming Settings
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Bot Settings -->
                    <div class="tab-pane fade" id="bots" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-robot"></i> Bot Configuration</h5>
                            </div>
                            <div class="card-body">
                                <form id="botsForm">
                                    <h6>Comment Bot Settings</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="commentEnabled" class="form-label">Enable Comment Bot</label>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="commentEnabled" name="comment_enabled">
                                                    <label class="form-check-label" for="commentEnabled">Enabled</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="commentInterval" class="form-label">Comment Interval (seconds)</label>
                                                <input type="number" class="form-control" id="commentInterval" name="comment_interval" 
                                                       value="30" min="10" max="300">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="maxComments" class="form-label">Max Comments per Session</label>
                                                <input type="number" class="form-control" id="maxComments" name="max_comments" 
                                                       value="50" min="1" max="500">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="randomDelay" class="form-label">Random Delay (±seconds)</label>
                                                <input type="number" class="form-control" id="randomDelay" name="random_delay" 
                                                       value="10" min="0" max="60">
                                            </div>
                                        </div>
                                    </div>

                                    <hr>

                                    <h6>Viewer Bot Settings</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="viewerEnabled" class="form-label">Enable Viewer Bot</label>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="viewerEnabled" name="viewer_enabled">
                                                    <label class="form-check-label" for="viewerEnabled">Enabled</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="maxViewers" class="form-label">Max Concurrent Viewers</label>
                                                <input type="number" class="form-control" id="maxViewers" name="max_viewers" 
                                                       value="10" min="1" max="100">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="sessionDuration" class="form-label">Session Duration (minutes)</label>
                                                <input type="number" class="form-control" id="sessionDuration" name="session_duration" 
                                                       value="15" min="5" max="120">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="useProxies" name="use_proxies">
                                                <label class="form-check-label" for="useProxies">
                                                    Use proxy rotation
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Bot Settings
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- YouTube API Settings -->
                    <div class="tab-pane fade" id="youtube" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fab fa-youtube"></i> YouTube API Configuration</h5>
                            </div>
                            <div class="card-body">
                                <form id="youtubeForm">
                                    <div class="mb-3">
                                        <label for="apiKey" class="form-label">YouTube Data API Key</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="apiKey" name="api_key" required>
                                            <button class="btn btn-outline-secondary" type="button" id="toggleApiKey">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">Get this from Google Cloud Console</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="clientId" class="form-label">OAuth2 Client ID</label>
                                        <input type="text" class="form-control" id="clientId" name="client_id" required>
                                        <div class="form-text">OAuth2 Client ID for authentication</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="clientSecret" class="form-label">OAuth2 Client Secret</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="clientSecret" name="client_secret" required>
                                            <button class="btn btn-outline-secondary" type="button" id="toggleClientSecret">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">OAuth2 Client Secret</div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="rateLimit" class="form-label">API Rate Limit (requests/hour)</label>
                                                <input type="number" class="form-control" id="rateLimit" name="rate_limit" 
                                                       value="100" min="10" max="1000">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="timeout" class="form-label">Request Timeout (seconds)</label>
                                                <input type="number" class="form-control" id="timeout" name="timeout" 
                                                       value="30" min="5" max="120">
                                            </div>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save API Settings
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="testConnection">
                                        <i class="fas fa-plug"></i> Test Connection
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="tab-pane fade" id="security" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-shield-alt"></i> Security Configuration</h5>
                            </div>
                            <div class="card-body">
                                <form id="securityForm">
                                    <div class="mb-3">
                                        <label for="dashboardPassword" class="form-label">Dashboard Password</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="dashboardPassword" name="dashboard_password">
                                            <button class="btn btn-outline-secondary" type="button" id="toggleDashboardPassword">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">Leave empty to disable password protection</div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="sessionTimeout" class="form-label">Session Timeout (minutes)</label>
                                                <input type="number" class="form-control" id="sessionTimeout" name="session_timeout" 
                                                       value="60" min="15" max="480">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="maxFailedAttempts" class="form-label">Max Failed Login Attempts</label>
                                                <input type="number" class="form-control" id="maxFailedAttempts" name="max_failed_attempts" 
                                                       value="5" min="3" max="20">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="enableLogging" name="enable_logging" checked>
                                                <label class="form-check-label" for="enableLogging">
                                                    Enable detailed logging
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="enableCors" name="enable_cors">
                                                <label class="form-check-label" for="enableCors">
                                                    Enable CORS
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Security Settings
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Toggle password visibility
        document.querySelectorAll('[id^="toggle"]').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.parentNode.querySelector('input');
                const icon = this.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        });

        // Show/hide video file input based on video input selection
        document.getElementById('videoInput').addEventListener('change', function() {
            const videoFileGroup = document.getElementById('videoFile').closest('.mb-3');
            if (this.value === 'file') {
                videoFileGroup.style.display = 'block';
            } else {
                videoFileGroup.style.display = 'none';
            }
        });

        // Load current settings
        function loadSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateForm(data.settings);
                    }
                })
                .catch(error => console.error('Error loading settings:', error));
        }

        // Populate form with settings data
        function populateForm(settings) {
            // Streaming settings
            if (settings.streaming) {
                Object.entries(settings.streaming).forEach(([key, value]) => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value;
                        } else {
                            element.value = value;
                        }
                    }
                });
            }

            // Bot settings
            if (settings.bots) {
                Object.entries(settings.bots).forEach(([key, value]) => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value;
                        } else {
                            element.value = value;
                        }
                    }
                });
            }

            // YouTube API settings
            if (settings.youtube) {
                Object.entries(settings.youtube).forEach(([key, value]) => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        element.value = value;
                    }
                });
            }

            // Security settings
            if (settings.security) {
                Object.entries(settings.security).forEach(([key, value]) => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value;
                        } else {
                            element.value = value;
                        }
                    }
                });
            }

            // Trigger video input change to show/hide file input
            document.getElementById('videoInput').dispatchEvent(new Event('change'));
        }

        // Save settings
        function saveSettings(formId, category) {
            const form = document.getElementById(formId);
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                if (form.querySelector(`[name="${key}"]`).type === 'checkbox') {
                    data[key] = form.querySelector(`[name="${key}"]`).checked;
                } else {
                    data[key] = value;
                }
            }

            fetch('/api/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    category: category,
                    settings: data
                })
            })
            .then(response => response.json())
            .then(data => {
                showAlert(data.message, data.success ? 'success' : 'danger');
            })
            .catch(error => {
                showAlert('Error saving settings: ' + error.message, 'danger');
            });
        }

        // Show alert message
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Form submit handlers
        document.getElementById('streamingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveSettings('streamingForm', 'streaming');
        });

        document.getElementById('botsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveSettings('botsForm', 'bots');
        });

        document.getElementById('youtubeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveSettings('youtubeForm', 'youtube');
        });

        document.getElementById('securityForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveSettings('securityForm', 'security');
        });

        // Test YouTube API connection
        document.getElementById('testConnection').addEventListener('click', function() {
            const button = this;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            button.disabled = true;

            fetch('/api/test-youtube-connection', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                showAlert(data.message, data.success ? 'success' : 'danger');
            })
            .catch(error => {
                showAlert('Connection test failed: ' + error.message, 'danger');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
        });

        // Load settings on page load
        document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
</body>
</html>
